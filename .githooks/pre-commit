#!/usr/bin/env bash
# Prevent accidental commits of .env files containing secrets.
set -euo pipefail

# Find staged files
staged_files=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$staged_files" ]; then
  exit 0
fi

for f in $staged_files; do
  # Normalize path
  bn=$(basename "$f")
  if [[ "$bn" == .env || "$bn" == .env.* || "$bn" == .env.local ]]; then
    echo "Error: refusing to commit environment file: $f"
    echo "Please remove any sensitive files from the commit and add them to .gitignore (e.g. .env.local)."
    exit 1
  fi
done

# Run a lightweight secret scanner on staged files
if command -v ./scripts/scan_secrets.py >/dev/null 2>&1; then
  if ! ./scripts/scan_secrets.py; then
    echo "Pre-commit secret scanner found possible secrets â€” aborting commit."
    exit 1
  fi
else
  # If missing, ignore but warn
  echo "Warning: secret scanner script not found (./scripts/scan_secrets.py). Skipping secret scan."
fi

exit 0
